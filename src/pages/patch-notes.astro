---
import BaseLayout from "../layouts/BaseLayout.astro";

const title = "Patch Notes | Eventide XI";
const description =
  "Stay up-to-date with the latest changes, bug fixes, and features on Eventide XI.";

// GitHub raw JSON URL for patch notes
const PATCH_NOTES_URL =
  "https://raw.githubusercontent.com/bananapretzel/eventide-patch-manifest/main/patch-notes.json";
---

<BaseLayout {title} {description}>
  <script
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: [
        {
          "@type": "ListItem",
          position: 1,
          name: "Home",
          item: "https://eventide-xi.com/",
        },
        {
          "@type": "ListItem",
          position: 2,
          name: "Patch Notes",
          item: "https://eventide-xi.com/patch-notes",
        },
      ],
    })}
  />

  <main class="container container-patch-notes" id="main-content">
    <h1>Patch Notes</h1>

    <div id="patch-notes-root" class="patch-notes-list" aria-live="polite">
      <div class="loading-message">
        <p>Loading patch notes...</p>
      </div>
    </div>
  </main>
  <script type="module">
    const PATCH_NOTES_URL =
      "https://raw.githubusercontent.com/bananapretzel/eventide-patch-manifest/main/patch-notes.json";
    const CACHE_KEY = "eventidexi-patch-notes-cache-v1";
    const CACHE_TTL_MS = 12 * 60 * 60 * 1000; // 12 hours

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    }

    function renderPatchNotes(notes) {
      const root = document.getElementById("patch-notes-root");
      if (!root) return;

      root.innerHTML = "";

      if (!Array.isArray(notes) || notes.length === 0) {
        const empty = document.createElement("div");
        empty.className = "loading-message";
        empty.innerHTML = "<p>No patch notes available yet.</p>";
        root.appendChild(empty);
        return;
      }

      notes.forEach((note) => {
        const article = document.createElement("article");
        article.className = "patch-note";

        const header = document.createElement("header");
        header.className = "patch-note-header";

        const author = document.createElement("h2");
        author.className = "patch-note-author";
        author.textContent = note.name || "Unknown";

        const time = document.createElement("time");
        time.className = "patch-note-date";
        time.dateTime = note.timestamp || "";
        time.textContent = note.timestamp ? formatDate(note.timestamp) : "";

        header.appendChild(author);
        header.appendChild(time);

        const content = document.createElement("div");
        content.className = "patch-note-content";

        const lines = (note.message || "").split("\n");
        lines.forEach((line) => {
          const p = document.createElement("p");
          p.textContent = line;
          content.appendChild(p);
        });

        article.appendChild(header);
        article.appendChild(content);
        root.appendChild(article);
      });
    }

    function loadFromCache() {
      try {
        const raw = window.localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const cached = JSON.parse(raw);
        if (!cached || !cached.timestamp || !cached.notes) return null;
        if (Date.now() - cached.timestamp > CACHE_TTL_MS) return null;
        return cached.notes;
      } catch {
        return null;
      }
    }

    function saveToCache(notes) {
      try {
        const payload = { timestamp: Date.now(), notes };
        window.localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
      } catch {
        // Ignore storage errors (e.g. private mode)
      }
    }

    async function fetchPatchNotes() {
      const root = document.getElementById("patch-notes-root");
      try {
        const response = await fetch(PATCH_NOTES_URL, {
          headers: { Accept: "application/json" },
        });
        if (!response.ok) {
          throw new Error(`Failed to fetch patch notes: ${response.status}`);
        }
        const notes = await response.json();
        notes.sort(
          (a, b) =>
            new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime(),
        );
        renderPatchNotes(notes);
        saveToCache(notes);
      } catch (error) {
        console.error("Error fetching patch notes", error);
        const cached = loadFromCache();
        if (cached) {
          renderPatchNotes(cached);
        } else if (root) {
          root.innerHTML =
            '<div class="error-message"><p>Unable to load patch notes at this time. Please try again later.</p></div>';
        }
      }
    }

    (function init() {
      const cached = loadFromCache();
      if (cached) {
        renderPatchNotes(cached);
        // Also refresh in background
        fetchPatchNotes();
      } else {
        fetchPatchNotes();
      }
    })();
  </script>
</BaseLayout>
