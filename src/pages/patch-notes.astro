---
import BaseLayout from "../layouts/BaseLayout.astro";

// Enable server-side rendering for this page
export const prerender = false;

const title = "Patch Notes | Eventide XI";
const description =
  "Stay up-to-date with the latest changes, bug fixes, and features on Eventide XI.";

// Set cache headers: cache for 12 hours, then revalidate
Astro.response.headers.set(
  "Cache-Control",
  "s-maxage=43200, stale-while-revalidate=86400",
);

// Fetch patch notes at build time from GitHub raw URL for better performance
// This gets cached at build time and is regenerated on each deployment
const PATCH_NOTES_URL =
  "https://raw.githubusercontent.com/bananapretzel/eventide-patch-manifest/main/patch-notes.json";

interface PatchNote {
  name: string;
  timestamp: string;
  message: string;
}

let patchNotes: PatchNote[] = [];
let fetchError = false;

try {
  const response = await fetch(PATCH_NOTES_URL);
  if (!response.ok) {
    throw new Error(`Failed to fetch patch notes: ${response.statusText}`);
  }
  patchNotes = await response.json();

  // Sort by timestamp, most recent first
  patchNotes.sort(
    (a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime(),
  );
} catch (error) {
  console.error("Error fetching patch notes:", error);
  fetchError = true;
}

// Helper function to format date
function formatDate(timestamp: string): string {
  const date = new Date(timestamp);
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

<BaseLayout {title} {description}>
  <script
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: [
        {
          "@type": "ListItem",
          position: 1,
          name: "Home",
          item: "https://eventide-xi.com/",
        },
        {
          "@type": "ListItem",
          position: 2,
          name: "Patch Notes",
          item: "https://eventide-xi.com/patch-notes",
        },
      ],
    })}
  />

  <main class="container-patch-notes" id="main-content">
    <h1 class="h1-gradient-title" style="text-align: center;">Patch Notes</h1>

    {
      fetchError ? (
        <div class="error-message">
          <p style="text-align: center; color: #dc3545;">
            Unable to load patch notes at this time. Please try again later.
          </p>
        </div>
      ) : patchNotes.length === 0 ? (
        <div class="loading-message">
          <p style="text-align: center;">Loading patch notes...</p>
        </div>
      ) : (
        <div class="patch-notes-list">
          {patchNotes.map((note) => (
            <article class="patch-note">
              <header class="patch-note-header">
                <h2 class="patch-note-author">{note.name}</h2>
                <time class="patch-note-date" datetime={note.timestamp}>
                  {formatDate(note.timestamp)}
                </time>
              </header>
              <div class="patch-note-content">
                {note.message.split("\n").map((line) => (
                  <p>{line}</p>
                ))}
              </div>
            </article>
          ))}
        </div>
      )
    }
  </main>
</BaseLayout>
